<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>LocalMind Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- ç®€å•ç°ä»£åŒ–æ ·å¼ -->
  <style>
      :root {
          color-scheme: dark light;
          --bg: #020617;
          --panel: #020617;
          --accent: #3b82f6;
          --accent-soft: rgba(59, 130, 246, 0.16);
          --border: rgba(148, 163, 184, 0.35);
          --text: #e5e7eb;
          --text-soft: #9ca3af;
      }

      * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
      }

      body {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
          background: radial-gradient(circle at top, #1f2937 0, #020617 50%, #000 100%);
          color: var(--text);
          min-height: 100vh;
          display: flex;
          align-items: stretch;
          justify-content: center;
          padding: 16px;
      }

      #app {
          width: 100%;
          max-width: 1040px;
          border-radius: 24px;
          border: 1px solid var(--border);
          background: radial-gradient(circle at top left, #111827, #020617);
          box-shadow: 0 26px 70px rgba(15, 23, 42, 0.9),
          0 0 0 1px rgba(15, 23, 42, 0.8);
          display: flex;
          flex-direction: column;
          overflow: hidden;
      }

      .header {
          padding: 14px 18px;
          border-bottom: 1px solid var(--border);
          display: flex;
          align-items: center;
          justify-content: space-between;
          backdrop-filter: blur(16px);
          background: linear-gradient(
                  to bottom,
                  rgba(15, 23, 42, 0.95),
                  rgba(15, 23, 42, 0.9)
          );
      }

      .brand {
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .logo {
          width: 30px;
          height: 30px;
          border-radius: 12px;
          background: radial-gradient(circle at 30% 15%, #bfdbfe, #60a5fa 40%, #1d4ed8);
          border: 1px solid rgba(191, 219, 254, 0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          font-weight: 700;
          color: #020617;
          box-shadow: 0 12px 24px rgba(15, 23, 42, 0.9),
          0 0 0 1px rgba(15, 23, 42, 0.7);
      }

      .title {
          font-size: 16px;
          font-weight: 600;
          letter-spacing: 0.02em;
      }

      .subtitle {
          font-size: 12px;
          color: var(--text-soft);
      }

      .header-right {
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 12px;
          color: var(--text-soft);
      }

      .status-dot {
          width: 8px;
          height: 8px;
          border-radius: 999px;
          background: #22c55e;
          box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.25);
      }

      .badge {
          padding: 3px 8px;
          border-radius: 999px;
          border: 1px solid var(--border);
          font-size: 10px;
          letter-spacing: 0.08em;
          text-transform: uppercase;
      }

      .main {
          flex: 1;
          display: flex;
          flex-direction: column;
          padding: 12px 16px 10px;
          gap: 8px;
      }

      .messages {
          flex: 1;
          overflow-y: auto;
          padding: 8px 4px;
          display: flex;
          flex-direction: column;
          gap: 10px;
      }

      .msg-row {
          display: flex;
          gap: 8px;
          align-items: flex-start;
      }

      .msg-row.user {
          justify-content: flex-end;
      }

      .msg-avatar {
          width: 24px;
          height: 24px;
          border-radius: 999px;
          flex-shrink: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 11px;
          font-weight: 600;
      }

      .msg-avatar.user {
          background: linear-gradient(135deg, #38bdf8, #0ea5e9);
          color: #0f172a;
      }

      .msg-avatar.assistant {
          background: linear-gradient(135deg, #a855f7, #6366f1);
          color: #f9fafb;
      }

      .bubble {
          max-width: 80%;
          padding: 8px 10px;
          border-radius: 14px;
          font-size: 14px;
          line-height: 1.5;
          border: 1px solid transparent;
          box-shadow: 0 8px 18px rgba(15, 23, 42, 0.8);
      }

      .bubble.user {
          background: linear-gradient(135deg, #1d4ed8, #3b82f6);
          color: #eff6ff;
          border-color: rgba(191, 219, 254, 0.5);
          border-bottom-right-radius: 4px;
      }

      .bubble.assistant {
          background: radial-gradient(circle at top left, #1f2937, #020617);
          border-color: rgba(55, 65, 81, 0.9);
          border-bottom-left-radius: 4px;
      }

      .bubble-meta {
          margin-top: 4px;
          font-size: 11px;
          color: var(--text-soft);
          display: flex;
          justify-content: space-between;
          gap: 8px;
          opacity: 0.85;
      }

      .context-toggle {
          cursor: pointer;
          color: #93c5fd;
          text-decoration: underline;
      }

      .context {
          margin-top: 6px;
          padding: 6px 8px;
          border-radius: 10px;
          background: rgba(15, 23, 42, 0.95);
          border: 1px solid rgba(148, 163, 184, 0.35);
          font-size: 11px;
          color: var(--text-soft);
          max-height: 140px;
          overflow-y: auto;
          white-space: pre-wrap;
      }

      .empty-tip {
          text-align: center;
          margin-top: 20px;
          font-size: 13px;
          color: var(--text-soft);
      }

      .input-bar {
          border-top: 1px solid rgba(148, 163, 184, 0.35);
          padding: 10px 12px 12px;
          background: linear-gradient(
                  to top,
                  rgba(15, 23, 42, 0.98),
                  rgba(15, 23, 42, 0.92)
          );
          display: flex;
          flex-direction: column;
          gap: 8px;
      }

      .input-row {
          display: flex;
          gap: 8px;
          align-items: flex-end;
      }

      textarea {
          resize: none;
          width: 100%;
          min-height: 44px;
          max-height: 120px;
          padding: 8px 10px;
          border-radius: 12px;
          border: 1px solid rgba(148, 163, 184, 0.7);
          background: rgba(15, 23, 42, 0.95);
          color: var(--text);
          font-family: inherit;
          font-size: 14px;
          line-height: 1.5;
          outline: none;
          transition: border-color 0.15s ease, box-shadow 0.15s ease,
          background 0.15s ease;
      }

      textarea:focus {
          border-color: var(--accent);
          box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
          background: rgba(15, 23, 42, 0.98);
      }

      .btn {
          cursor: pointer;
          border: none;
          border-radius: 12px;
          padding: 9px 14px;
          font-size: 13px;
          font-weight: 500;
          background: linear-gradient(135deg, #2563eb, #3b82f6);
          color: #eff6ff;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          box-shadow: 0 12px 24px rgba(37, 99, 235, 0.65),
          0 0 0 1px rgba(15, 23, 42, 0.9);
          white-space: nowrap;
      }

      .btn:disabled {
          opacity: 0.6;
          cursor: default;
          box-shadow: none;
      }

      .btn-secondary {
          background: rgba(15, 23, 42, 0.9);
          color: var(--text-soft);
          border: 1px solid rgba(148, 163, 184, 0.7);
          box-shadow: none;
      }

      .footer-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-size: 11px;
          color: var(--text-soft);
          padding: 0 2px;
      }

      .error {
          color: #fecaca;
      }

      @media (max-width: 640px) {
          #app {
              border-radius: 18px;
              padding: 0;
          }

          .main {
              padding: 8px 10px;
          }

          .input-bar {
              padding: 8px 8px 10px;
          }

          .bubble {
              max-width: 100%;
          }
      }

      .markdown-body {
          font-size: 14px;
          line-height: 1.7;
      }

      .markdown-body p {
          margin: 4px 0;
      }

      .markdown-body code {
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
          font-size: 12px;
          background: rgba(15, 23, 42, 0.9);
          padding: 2px 4px;
          border-radius: 4px;
          border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .markdown-body pre {
          background: rgba(15, 23, 42, 0.95);
          border-radius: 8px;
          padding: 8px;
          overflow-x: auto;
          border: 1px solid rgba(31, 41, 55, 0.9);
      }

      .markdown-body h1,
      .markdown-body h2,
      .markdown-body h3 {
          margin: 6px 0 4px;
          font-weight: 600;
      }

      .references-panel {
          margin-top: 8px;
          padding: 8px 9px;
          border-radius: 10px;
          border: 1px solid rgba(55, 65, 81, 0.9);
          background: rgba(15, 23, 42, 0.96);
          font-size: 12px;
      }

      .ref-title {
          font-size: 12px;
          font-weight: 500;
          margin-bottom: 6px;
      }

      .ref-item + .ref-item {
          margin-top: 6px;
          padding-top: 6px;
          border-top: 1px dashed rgba(31, 41, 55, 0.9);
      }

      .ref-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 2px;
      }

      .ref-index {
          color: #93c5fd;
      }

      .ref-source {
          color: #e5e7eb;
      }

      .ref-link {
          margin-left: auto;
          font-size: 11px;
          color: #60a5fa;
          text-decoration: none;
      }

      .ref-link:hover {
          text-decoration: underline;
      }

      .ref-snippet {
          color: #9ca3af;
          font-size: 11px;
      }

      /* é™åˆ¶ Markdown å†…å®¹åœ¨æ¶ˆæ¯æ°”æ³¡å†…ä¸æº¢å‡º */
      .bubble .markdown-body {
          overflow-wrap: break-word;
          word-break: break-word;
          white-space: normal;
          max-width: 100%;
      }

      /* é˜²æ­¢ä»£ç å—æ¨ªå‘æ’‘ç ´å®¹å™¨ */
      .bubble .markdown-body pre {
          max-width: 100%;
          overflow-x: auto;
          white-space: pre-wrap; /* è‡ªåŠ¨æ¢è¡Œ */
          word-break: break-word;
      }

      /* é˜²æ­¢å†…è”ä»£ç æ’‘ç ´ */
      .bubble .markdown-body code {
          max-width: 100%;
          white-space: break-spaces;
      }

      /* å›¾ç‰‡è‡ªé€‚åº”æ¶ˆæ¯æ°”æ³¡å®½åº¦ */
      .bubble .markdown-body img {
          max-width: 100%;
          height: auto;
          border-radius: 6px;
          display: block;
          margin: 6px 0;
      }

      /* è¡¨æ ¼ä¸æº¢å‡º */
      .bubble .markdown-body table {
          max-width: 100%;
          display: block;
          overflow-x: auto;
          border-collapse: collapse;
      }

      /* é“¾æ¥æ¢è¡Œ */
      .bubble .markdown-body a {
          word-break: break-all;
      }

      /* ä¿®å¤å¼•ç”¨åŒºåŸŸå†…éƒ¨æ¢è¡Œ */
      .references-panel {
          overflow: hidden;
      }

      .ref-snippet {
          white-space: normal;
          word-break: break-word;
      }

      /* è®©åˆ—è¡¨åœ¨æ°”æ³¡é‡Œé¢è§„çŸ©ä¸€ç‚¹ï¼Œä¸å†å¾€å·¦é¡¶å‡ºåœ†è§’ */
      .bubble .markdown-body ul,
      .bubble .markdown-body ol {
          margin-left: 0; /* ä¸è¦å†å¾€å¤–æŒ¤ */
          padding-left: 1.2em; /* ç”¨å†…è¾¹è·åšç¼©è¿› */
          margin-top: 4px;
          margin-bottom: 4px;
          list-style-position: outside; /* å­å¼¹å¤´åœ¨ç¼©è¿›å†…ï¼Œä»ç„¶å¥½çœ‹ */
      }

      /* å­é¡¹ç›®ä¹‹é—´çš„é—´è·æŸ”å’Œä¸€ç‚¹ */
      .bubble .markdown-body li {
          margin: 2px 0;
      }

      /* blockquote ä¹Ÿå¯èƒ½é¡¶å‡ºå·¦ä¾§ï¼Œè¿™é‡Œä¹Ÿæ‹‰å›æ¥ */
      .bubble .markdown-body blockquote {
          margin-left: 0;
          margin-right: 0;
          padding-left: 0.8em;
          border-left: 3px solid rgba(148, 163, 184, 0.7);
      }

      .nav-link {
          padding: 6px 10px;
          border-radius: 8px;
          background: rgba(59, 130, 246, 0.15);
          border: 1px solid rgba(59, 130, 246, 0.4);
          color: #93c5fd;
          text-decoration: none;
          font-size: 12px;
          margin-right: 12px;
          transition: 0.15s ease;
      }

      .nav-link:hover {
          background: rgba(59, 130, 246, 0.35);
          border-color: rgba(147, 197, 253, 0.8);
          color: #e0f2fe;
      }


  </style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="brand">
      <div class="logo">LM</div>
      <div>
        <div class="title">LocalMind Chat</div>
        <div class="subtitle">æœ¬åœ°çŸ¥è¯†åŠ©æ‰‹ Â· Qwen æ¥å…¥</div>
      </div>
    </div>
    <div class="header-right">
      <div class="status-dot"></div>
      <span>Backend: {{ backendUrl }}</span>
      <span class="badge">MVP</span>
      <a href="/admin" class="nav-link">ç®¡ç†é¡µé¢</a>
      <a href="/vectors" class="nav-link">å‘é‡æµè§ˆ</a>
    </div>
  </div>

  <div class="main">
    <div class="messages" ref="messageList">
      <div v-if="messages.length === 0" class="empty-tip">
        ğŸ‘‹ è¿˜æ²¡æœ‰å¯¹è¯ï¼Œå…ˆé—®ä¸€ä¸ªä¸ä½ æœ¬åœ°çŸ¥è¯†åº“ç›¸å…³çš„é—®é¢˜è¯•è¯•å§ã€‚
      </div>

      <div v-for="(msg, idx) in messages"
           :key="idx"
           class="msg-row"
           :class="msg.role">
        <div v-if="msg.role === 'assistant'" class="msg-avatar assistant">AI</div>
        <div v-if="msg.role === 'user'" class="msg-avatar user">Me</div>

        <div class="bubble" :class="msg.role">
          <!-- Markdown æ¸²æŸ“çš„å›ç­”å†…å®¹ -->
          <div class="markdown-body" v-html="formatMarkdown(msg.content)"></div>

          <div class="bubble-meta">
            <span>{{ msg.role === 'user' ? 'æé—®' : 'å›ç­”' }}</span>
            <span v-if="msg.time">{{ msg.time }}</span>
            <span
                v-if="msg.role === 'assistant' && msg.context && msg.context.length"
                class="context-toggle"
                @click="msg.showContext = !msg.showContext"
            >
              {{ msg.showContext ? 'æ”¶èµ·å¼•ç”¨æ¥æº' : 'æŸ¥çœ‹å¼•ç”¨æ¥æº' }}
            </span>
          </div>

          <!-- å¼•ç”¨æ¥æºåŒºåŸŸï¼šå±•ç¤ºç‰‡æ®µ + åŸæ–‡é“¾æ¥ -->
          <div
              v-if="msg.role === 'assistant' && msg.context && msg.context.length && msg.showContext"
              class="references-panel"
          >
            <div class="ref-title">å¼•ç”¨æ¥æº</div>
            <div class="ref-list">
              <div
                  class="ref-item"
                  v-for="(chunk, i) in msg.context"
                  :key="i"
              >
                <div class="ref-header">
                  <span class="ref-index">[{{ i + 1 }}]</span>
                  <span class="ref-source">
                    {{ resolveSourceLabel(getChunkMeta(chunk)) }}
                  </span>
                  <a
                      v-if="hasFileLink(getChunkMeta(chunk))"
                      :href="buildFileUrl(getChunkMeta(chunk))"
                      target="_blank"
                      class="ref-link"
                  >
                    é¢„è§ˆ / ä¸‹è½½åŸæ–‡
                  </a>
                </div>
                <div class="ref-snippet">
                  {{ snippet(getChunkText(chunk)) }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="input-bar">
      <div class="input-row">
        <textarea
            v-model="input"
            :rows="1"
            @keydown.enter.exact.prevent="send"
            @keydown.shift.enter.stop
            placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼ŒEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œâ€¦"
        ></textarea>
        <button class="btn" @click="send" :disabled="sending || !input.trim()">
          <span v-if="!sending">å‘é€</span>
          <span v-else>æ€è€ƒä¸­â€¦</span>
        </button>
      </div>
      <div class="footer-row">
        <div>
          <button class="btn btn-secondary" @click="clearHistory" :disabled="!messages.length">
            æ¸…ç©ºå¯¹è¯
          </button>
        </div>
        <div>
          <span v-if="error" class="error">âš ï¸ {{ error }}</span>
          <span v-else>æç¤ºï¼šè¯·å…ˆåœ¨åç«¯å¯¼å…¥æ–‡æ¡£å†è¿›è¡Œæé—®ã€‚</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Markdown æ¸²æŸ“ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Vue 3ï¼ˆæ¸è¿›å¼ï¼ŒCDNï¼‰ -->
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

<script>
    const {createApp, ref, reactive, onMounted, nextTick} = Vue;

    createApp({
        setup() {
            // åç«¯åœ°å€ï¼šå¦‚æœä½ æŠŠ chat.html é€šè¿‡ FastAPI åŒæºæä¾›ï¼Œå¯ä»¥ç”¨ç›¸å¯¹è·¯å¾„ "/query"
            // å¦‚æœæ˜¯ç›´æ¥ file:// æ‰“å¼€ï¼Œè¯·æ”¹ä¸ºå®Œæ•´åœ°å€ï¼Œå¦‚ "http://127.0.0.1:8787/query"
            const backendBase = "http://127.0.0.1:8787";

            const backendUrl = backendBase;
            const messages = reactive([]);
            const input = ref("");
            const sending = ref(false);
            const error = ref("");

            const messageList = ref(null);

            const scrollToBottom = () => {
                nextTick(() => {
                    if (messageList.value) {
                        messageList.value.scrollTop = messageList.value.scrollHeight;
                    }
                });
            };

            const nowTime = () => {
                const d = new Date();
                const hh = String(d.getHours()).padStart(2, "0");
                const mm = String(d.getMinutes()).padStart(2, "0");
                return `${hh}:${mm}`;
            };

            const send = async () => {
                if (sending.value) return;
                const q = input.value.trim();
                if (!q) return;

                error.value = "";
                input.value = "";

                messages.push({
                    role: "user",
                    content: q,
                    time: nowTime()
                });
                scrollToBottom();

                sending.value = true;

                try {
                    const resp = await fetch(backendBase + "/query", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            question: q,
                            top_k: 5
                        })
                    });

                    if (!resp.ok) {
                        throw new Error("HTTP " + resp.status);
                    }

                    const data = await resp.json();

                    messages.push({
                        role: "assistant",
                        content: data.answer || "(æ— å›ç­”)",
                        context: data.context_chunks || [],
                        showContext: false,
                        time: nowTime()
                    });
                    scrollToBottom();
                } catch (e) {
                    console.error(e);
                    error.value = "è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å·²è¿è¡Œæˆ– CORS è®¾ç½®ã€‚";
                } finally {
                    sending.value = false;
                }
            };

            const clearHistory = () => {
                messages.splice(0, messages.length);
            };

            const formatMarkdown = (text) => {
                if (!text) return "";
                try {
                    return marked.parse(text);
                } catch (e) {
                    console.error("Markdown æ¸²æŸ“å¤±è´¥", e);
                    // å‡ºé”™åˆ™é€€å›åŸºç¡€è½¬ä¹‰
                    return String(text)
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/\n/g, "<br>");
                }
            };

            const getChunkText = (chunk) => {
                if (!chunk) return "";
                if (typeof chunk === "string") return chunk;
                if (typeof chunk === "object" && chunk.text) return chunk.text;
                return JSON.stringify(chunk);
            };

            const getChunkMeta = (chunk) => {
                if (!chunk || typeof chunk !== "object") return null;
                if (chunk.metadata && typeof chunk.metadata === "object") {
                    return chunk.metadata;
                }
                // å…¼å®¹ï¼šå¦‚æœåç«¯ç›´æ¥æŠŠ meta å¹³é“ºåœ¨å¯¹è±¡ä¸Š
                return chunk;
            };

            const snippet = (text) => {
                if (!text) return "";
                const t = text.replace(/\s+/g, " ").trim();
                return t.length > 120 ? t.slice(0, 120) + "..." : t;
            };

            const resolveSourceLabel = (meta) => {
                if (!meta) return "æœªçŸ¥æ¥æº";

                if (meta.folder_name || meta.file_path) {
                    const name = meta.folder_name || "æœªå‘½åæ–‡ä»¶å¤¹";
                    const path = meta.file_path || "";
                    return `${name} Â· ${path}`;
                }

                if (meta.title || meta.doc_id) {
                    return meta.title || meta.doc_id || "æ‰‹åŠ¨å¯¼å…¥æ–‡æ¡£";
                }

                return "æœªæ ‡æ³¨æ¥æº";
            };

            const hasFileLink = (meta) => {
                return meta && meta.folder_id && meta.file_path;
            };

            const buildFileUrl = (meta) => {
                if (!hasFileLink(meta)) return "#";
                const params = new URLSearchParams({
                    folder_id: meta.folder_id,
                    path: meta.file_path
                });
                return "/files/raw?" + params.toString();
            };

            onMounted(() => {
                scrollToBottom();
            });

            return {
                backendUrl,
                messages,
                input,
                sending,
                error,
                send,
                clearHistory,
                formatMarkdown,
                messageList,
                // æ–°å¢ç»™æ¨¡æ¿ç”¨çš„è¾…åŠ©æ–¹æ³•
                getChunkText,
                getChunkMeta,
                snippet,
                resolveSourceLabel,
                hasFileLink,
                buildFileUrl
            };
        }
    }).mount("#app");
</script>
</body>
</html>
